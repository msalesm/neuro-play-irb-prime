import { useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts';
import { Download, AlertTriangle, Heart, BookOpen, Users } from 'lucide-react';
import jsPDF from 'jspdf';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';

interface VulnerabilityMapProps {
  observations: any[];
  students: any[];
  className?: string;
  weekLabel: string;
}

const COLORS = {
  low: 'hsl(var(--chart-3))',
  moderate: 'hsl(var(--chart-4))',
  high: 'hsl(var(--chart-5))',
};

export function VulnerabilityMap({ observations, students, className, weekLabel }: VulnerabilityMapProps) {
  const metrics = useMemo(() => {
    if (observations.length === 0) return null;

    const total = observations.length;

    // Emotional difficulty: persistent_sadness or social_isolation >= 2
    const emotionalCount = observations.filter(
      (o: any) => o.persistent_sadness >= 2 || o.social_isolation >= 2
    ).length;

    // Learning difficulty: focus_difficulty or performance_drop >= 2
    const learningCount = observations.filter(
      (o: any) => o.focus_difficulty >= 2 || o.performance_drop >= 2
    ).length;

    // Social risk: aggressiveness or behavior_change >= 2
    const socialCount = observations.filter(
      (o: any) => o.aggressiveness >= 2 || o.behavior_change >= 2
    ).length;

    return {
      total,
      emotional: { count: emotionalCount, pct: Math.round((emotionalCount / total) * 100) },
      learning: { count: learningCount, pct: Math.round((learningCount / total) * 100) },
      social: { count: socialCount, pct: Math.round((socialCount / total) * 100) },
    };
  }, [observations]);

  const riskDistribution = useMemo(() => {
    const low = observations.filter((o: any) => o.risk_level === 'low').length;
    const moderate = observations.filter((o: any) => o.risk_level === 'moderate').length;
    const high = observations.filter((o: any) => o.risk_level === 'high').length;
    return [
      { name: 'Adequado', value: low, color: COLORS.low },
      { name: 'Atenção', value: moderate, color: COLORS.moderate },
      { name: 'Prioridade', value: high, color: COLORS.high },
    ].filter(d => d.value > 0);
  }, [observations]);

  const exportPDF = () => {
    const doc = new jsPDF();
    const now = format(new Date(), "dd/MM/yyyy HH:mm", { locale: ptBR });

    doc.setFontSize(18);
    doc.text('Mapa de Vulnerabilidade da Turma', 20, 25);
    doc.setFontSize(11);
    doc.text(`${className || 'Turma'} • Semana ${weekLabel}`, 20, 33);
    doc.text(`Gerado em: ${now}`, 20, 40);

    doc.setFontSize(12);
    doc.text('Indicadores Gerais', 20, 55);
    doc.setFontSize(10);

    if (metrics) {
      doc.text(`Total de alunos observados: ${metrics.total}`, 25, 63);
      doc.text(`Dificuldade emocional: ${metrics.emotional.pct}% (${metrics.emotional.count} alunos)`, 25, 70);
      doc.text(`Dificuldade de aprendizagem: ${metrics.learning.pct}% (${metrics.learning.count} alunos)`, 25, 77);
      doc.text(`Risco social: ${metrics.social.pct}% (${metrics.social.count} alunos)`, 25, 84);
    }

    doc.setFontSize(12);
    doc.text('Distribuição de Risco', 20, 100);
    doc.setFontSize(10);
    riskDistribution.forEach((item, i) => {
      doc.text(`${item.name}: ${item.value} alunos`, 25, 108 + i * 7);
    });

    doc.setFontSize(8);
    doc.text('⚠️ Ferramenta de apoio educacional. Não substitui avaliação clínica.', 20, 280);
    doc.text('Dados anonimizados para uso institucional.', 20, 285);

    doc.save(`mapa-vulnerabilidade-${format(new Date(), 'yyyy-MM-dd')}.pdf`);
  };

  if (!metrics) {
    return (
      <Card className="border-border">
        <CardContent className="p-8 text-center">
          <AlertTriangle className="h-10 w-10 mx-auto mb-3 text-muted-foreground opacity-50" />
          <p className="text-muted-foreground text-sm">Nenhuma observação registrada nesta semana.</p>
          <p className="text-xs text-muted-foreground mt-1">Registre check-ins para gerar o mapa.</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {/* Vulnerability indicators */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <Card className="border-border">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <Heart className="h-6 w-6 text-rose-500 shrink-0" />
              <div>
                <p className="text-2xl font-bold">{metrics.emotional.pct}%</p>
                <p className="text-xs text-muted-foreground">Dificuldade emocional</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card className="border-border">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <BookOpen className="h-6 w-6 text-amber-500 shrink-0" />
              <div>
                <p className="text-2xl font-bold">{metrics.learning.pct}%</p>
                <p className="text-xs text-muted-foreground">Dificuldade de aprendizagem</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card className="border-border">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <Users className="h-6 w-6 text-orange-500 shrink-0" />
              <div>
                <p className="text-2xl font-bold">{metrics.social.pct}%</p>
                <p className="text-xs text-muted-foreground">Risco social</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Risk distribution chart */}
      <Card className="border-border">
        <CardHeader className="pb-2">
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-base">Distribuição de Risco</CardTitle>
              <CardDescription>{metrics.total} alunos observados</CardDescription>
            </div>
            <Button variant="outline" size="sm" className="gap-2" onClick={exportPDF}>
              <Download className="h-4 w-4" />
              Exportar
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          {riskDistribution.length > 0 ? (
            <ResponsiveContainer width="100%" height={200}>
              <PieChart>
                <Pie
                  data={riskDistribution}
                  cx="50%"
                  cy="50%"
                  innerRadius={50}
                  outerRadius={80}
                  paddingAngle={3}
                  dataKey="value"
                >
                  {riskDistribution.map((entry, index) => (
                    <Cell key={index} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
          ) : (
            <p className="text-center text-muted-foreground text-sm py-8">Sem dados suficientes.</p>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
